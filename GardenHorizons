local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
    Name = "SCJ Horizons V2.5 | AFK GOD + CONTINUOUS BUY",
    LoadingTitle = "ƒêang t·∫£i c·∫•u h√¨nh IJC_01...",
    LoadingSubtitle = "by Gemini & Ut",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "IJC_01",
        FileName = "IJC_01_Config"
    },
    KeySystem = false,
})

local _G = {
    MainEnabled = false,
    AutoSellActive = false,
    InventoryLimit = 299,
    AutoBuySeed = {},
    GardenCFrame = nil,
    LastInventoryCount = 0,
    BuyLoopActive = {}
}

local VirtualInputManager = game:GetService("VirtualInputManager")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Player = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local RemoteEventsFolder = ReplicatedStorage:WaitForChild("RemoteEvents")
local PurchaseShopItem = RemoteEventsFolder:WaitForChild("PurchaseShopItem")
local GetShopData = RemoteEventsFolder:WaitForChild("GetShopData")
local SellItems = RemoteEventsFolder:WaitForChild("SellItems")

local SHOP_POSITION = CFrame.new(176.70369, 201.054993, 672)
local SELL_POSITION = CFrame.new(149.3974, 201.054993, 671.999878)

-- Cache shop data
local ShopCache = { data = nil, lastUpdate = 0 }
local CACHE_TIME = 1.5

-- Toggle references
local toggles = {
    farm = nil,
    sell = nil,
    seeds = {}
}

-- ==========================================
-- INVENTORY COUNT
-- ==========================================
local function GetRealInventoryCount()
    local total = 0
    pcall(function()
        -- Backpack
        if Player.Backpack then
            for _, item in ipairs(Player.Backpack:GetChildren()) do
                local amt = item:FindFirstChild("Amount") or item:FindFirstChild("Quantity") or item:FindFirstChild("Value")
                total = total + (amt and amt.Value or 1)
            end
        end
        
        -- Character (equipped tools)
        if Player.Character then
            for _, item in ipairs(Player.Character:GetChildren()) do
                if item:IsA("Tool") then
                    local amt = item:FindFirstChild("Amount") or item:FindFirstChild("Quantity")
                    total = total + (amt and amt.Value or 1)
                end
            end
        end
        
        -- UI display (most reliable in many games)
        local gui = Player:FindFirstChild("PlayerGui")
        if gui then
            local hud = gui:FindFirstChild("Hud_UI")
            if hud then
                local side = hud:FindFirstChild("SideButtons")
                if side then
                    local seedsUI = side:FindFirstChild("Seeds")
                    if seedsUI then
                        local amt = seedsUI:FindFirstChild("Amount")
                        if amt and amt.Text then
                            local num = amt.Text:match("%d+")
                            if num then
                                total = tonumber(num) or total
                            end
                        end
                    end
                end
            end
        end
    end)
    
    _G.LastInventoryCount = total
    return total
end

-- ==========================================
-- SHOP DATA
-- ==========================================
local function GetShopDataRemote(force)
    if not force and tick() - ShopCache.lastUpdate < CACHE_TIME and ShopCache.data then
        return ShopCache.data
    end
    
    local success, data = pcall(function()
        return GetShopData:InvokeServer("SeedShop")
    end)
    
    if success and data then
        ShopCache.data = data
        ShopCache.lastUpdate = tick()
    end
    
    return data
end

local function GetSeedStock(seedName)
    local data = GetShopDataRemote()
    if data and data.Items and data.Items[seedName] then
        return data.Items[seedName].Amount or 0
    end
    return 0
end

-- ==========================================
-- BUY & SELL
-- ==========================================
local function BuySeed(seedName)
    local oldInv = GetRealInventoryCount()
    
    local success = pcall(function()
        PurchaseShopItem:InvokeServer("SeedShop", seedName)
    end)
    
    task.wait(0.35 + math.random(5, 25)/100) -- 0.4 ~ 0.6s
    
    if GetRealInventoryCount() > oldInv then
        return true
    end
    
    -- Force refresh cache on fail
    ShopCache.lastUpdate = 0
    return false
end

local function SellAll()
    pcall(function()
        SellItems:InvokeServer("SellAll")
    end)
end

-- ==========================================
-- TELEPORT
-- ==========================================
local function InstantTeleport(targetCFrame)
    local char = Player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return false end
    
    local hrp = char.HumanoidRootPart
    hrp.CFrame = targetCFrame + Vector3.new(0, 3, 0)
    hrp.Velocity = Vector3.new()
    return true
end

-- ==========================================
-- CONTINUOUS BUY LOOP
-- ==========================================
local function ContinuousBuyLoop(seedKey, seedName)
    if _G.BuyLoopActive[seedKey] then return end
    _G.BuyLoopActive[seedKey] = true
    
    task.spawn(function()
        while _G.AutoBuySeed[seedKey] do
            local stock = GetSeedStock(seedName)
            if stock <= 0 then
                task.wait(4 + math.random(2, 6))
                continue
            end
            
            InstantTeleport(SHOP_POSITION)
            task.wait(0.8 + math.random(0, 4)/10)
            
            local SAFETY_THRESHOLD = 15
            local fails = 0
            
            while _G.AutoBuySeed[seedKey] do
                local inv = GetRealInventoryCount()
                if inv >= (_G.InventoryLimit - SAFETY_THRESHOLD) then break end
                
                local curStock = GetSeedStock(seedName)
                if curStock <= 0 then break end
                
                if BuySeed(seedName) then
                    fails = 0
                    task.wait(0.18 + math.random(0, 6)/100)
                else
                    fails = fails + 1
                    task.wait(0.9 + fails * 0.3)
                    if fails > 4 then
                        task.wait(3)
                        break
                    end
                end
            end
            
            InstantTeleport(_G.GardenCFrame or CFrame.new(0, 200, 0))
            task.wait(2.5 + math.random(0, 4)/10)
        end
        
        _G.BuyLoopActive[seedKey] = nil
    end)
end

-- ==========================================
-- SYNC GLOBALS FROM TOGGLES
-- ==========================================
local function syncGlobals()
    if toggles.farm and toggles.farm.CurrentValue ~= nil then
        _G.MainEnabled = toggles.farm.CurrentValue
    end
    if toggles.sell and toggles.sell.CurrentValue ~= nil then
        _G.AutoSellActive = toggles.sell.CurrentValue
    end
    for key, tog in pairs(toggles.seeds) do
        if tog and tog.CurrentValue ~= nil then
            _G.AutoBuySeed[key] = tog.CurrentValue
        end
    end
    print("Config synced")
end

-- ==========================================
-- UI - TABS & TOGGLES
-- ==========================================
local TabMain = Window:CreateTab("Main Farm", 4483362458)

TabMain:CreateButton({
    Name = "üìç L∆ØU V·ªä TR√ç V∆Ø·ªúN (B·∫ÆT BU·ªòC)",
    Callback = function()
        if Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
            _G.GardenCFrame = Player.Character.HumanoidRootPart.CFrame
            Rayfield:Notify({
                Title = "‚úÖ OK",
                Content = "V·ªã tr√≠ v∆∞·ªùn ƒë√£ ƒë∆∞·ª£c l∆∞u!",
                Duration = 3
            })
        end
    end,
})

toggles.farm = TabMain:CreateToggle({
    Name = "üåæ Auto Farm (Harvest - Anti Wheat/Cabbage)",
    CurrentValue = false,
    Flag = "FarmToggle",
    Callback = function(Value)
        _G.MainEnabled = Value
        if Value then
            task.spawn(function()
                while _G.MainEnabled do
                    pcall(function()
                        local hrp = Player.Character and Player.Character.HumanoidRootPart
                        if hrp then
                            Camera.CameraType = Enum.CameraType.Scriptable
                            Camera.CFrame = CFrame.new(hrp.Position + Vector3.new(0,100,0), hrp.Position)
                        end
                    end)
                    task.wait()
                end
                Camera.CameraType = Enum.CameraType.Custom
            end)
        else
            Camera.CameraType = Enum.CameraType.Custom
        end
    end,
})

toggles.sell = TabMain:CreateToggle({
    Name = "üí∞ Auto Sell (TP khi ƒë·∫ßy)",
    CurrentValue = false,
    Flag = "SellToggle",
    Callback = function(Value)
        _G.AutoSellActive = Value
        if Value and not _G.GardenCFrame then
            Rayfield:Notify({
                Title = "L·ªói",
                Content = "Ch∆∞a l∆∞u v·ªã tr√≠ v∆∞·ªùn!",
                Duration = 4
            })
            _G.AutoSellActive = false
            toggles.sell:Set(false)
        end
    end,
})

-- Shop Seed Tab
local TabShop = Window:CreateTab("Shop Seed", 4483362458)

local seedList = {
    "Carrot Seed", "Corn Seed", "Onion Seed", "Strawberry Seed", "Mushroom Seed",
    "Beetroot Seed", "Tomato Seed", "Apple Seed", "Rose Seed", "Wheat Seed",
    "Banana Seed", "Plum Seed", "Potato Seed", "Cabbage Seed", "Cherry Seed",
    "Bamboo Seed", "Mango Seed"
}

for _, seedName in ipairs(seedList) do
    local key = seedName:gsub(" Seed", "")
    local tog = TabShop:CreateToggle({
        Name = "üî• CONTINUOUS BUY " .. seedName,
        CurrentValue = false,
        Flag = "Buy_" .. key,
        Callback = function(Value)
            _G.AutoBuySeed[key] = Value
            if not Value then
                Rayfield:Notify({
                    Title = "D·ª™NG",
                    Content = seedName,
                    Duration = 2
                })
            end
        end,
    })
    toggles.seeds[key] = tog
end

-- Debug Tab
local TabDebug = Window:CreateTab("Debug & Stock", 4483362458)

TabDebug:CreateButton({
    Name = "üì¶ CHECK STOCK T·∫§T C·∫¢ SEED",
    Callback = function()
        ShopCache.lastUpdate = 0
        local data = GetShopDataRemote(true)
        if data and data.Items then
            print("===== T·ªíN KHO SHOP - " .. os.date("%H:%M:%S") .. " =====")
            for name, info in pairs(data.Items) do
                print(name .. ": " .. (info.Amount or 0))
            end
            Rayfield:Notify({
                Title = "ƒê√£ in console",
                Content = "Nh·∫•n F9 ƒë·ªÉ xem",
                Duration = 4
            })
        else
            Rayfield:Notify({
                Title = "L·ªói",
                Content = "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu shop",
                Duration = 4
            })
        end
    end
})

TabDebug:CreateButton({
    Name = "üíæ L∆ØU CONFIG NGAY",
    Callback = function()
        syncGlobals()
        Rayfield:SaveConfiguration()
        Rayfield:Notify({
            Title = "ƒê√£ l∆∞u",
            Content = "Config ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t",
            Duration = 3
        })
    end
})

-- ==========================================
-- LOAD CONFIG & AUTO SYNC
-- ==========================================
task.delay(1.2, function()
    Rayfield:LoadConfiguration()
    task.wait(0.8)
    syncGlobals()
    
    if Rayfield.CurrentConfiguration and next(Rayfield.CurrentConfiguration) then
        Rayfield:Notify({
            Title = "‚úÖ Config Loaded & Synced",
            Content = "C√°c toggle c≈© ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c!",
            Duration = 5
        })
    else
        Rayfield:Notify({
            Title = "‚ö†Ô∏è Config M·ªõi",
            Content = "T·∫°o c·∫•u h√¨nh m·ªõi. Toggle s·∫Ω t·ª± ƒë·ªông l∆∞u khi thay ƒë·ªïi.",
            Duration = 6
        })
    end
end)

-- ==========================================
-- MAIN LOOP
-- ==========================================
task.spawn(function()
    while true do
        if _G.MainEnabled or _G.AutoSellActive or next(_G.AutoBuySeed) then
            -- Auto Sell
            if _G.AutoSellActive then
                local count = GetRealInventoryCount()
                if count >= _G.InventoryLimit then
                    InstantTeleport(SELL_POSITION)
                    task.wait(0.9)
                    SellAll()
                    task.wait(0.7)
                    InstantTeleport(_G.GardenCFrame or CFrame.new(0, 200, 0))
                    task.wait(2.5)
                end
            end
            
            -- Auto Buy (start loops if needed)
            for key, enabled in pairs(_G.AutoBuySeed) do
                if enabled and not _G.BuyLoopActive[key] then
                    local seedName = key .. " Seed"
                    ContinuousBuyLoop(key, seedName)
                end
            end
            
            -- Auto Harvest
            if _G.MainEnabled then
                pcall(function()
                    for _, v in pairs(workspace:GetDescendants()) do
                        if v:IsA("ProximityPrompt") and v.Enabled then
                            local promptText = ((v.ObjectText or "") .. " " .. (v.ActionText or "")):lower()
                            local parentName = (v.Parent and v.Parent.Name or ""):lower()
                            local grandName = (v.Parent and v.Parent.Parent and v.Parent.Parent.Name or ""):lower()
                            
                            local skip = parentName:find("wheat") or grandName:find("wheat") or
                                         promptText:find("wheat") or
                                         parentName:find("cabbage") or grandName:find("cabbage") or
                                         promptText:find("cabbage")
                            
                            if skip then continue end
                            
                            if promptText:find("harvest") then
                                v.HoldDuration = 0
                                v.MaxActivationDistance = 120
                                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
                                task.wait(0.05)
                                VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
                            end
                        end
                    end
                end)
            end
        end
        
        task.wait(0.13)
    end
end)
